<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ä¸€åˆä¸€ä¼š</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ffffff">

<style>
body {
  margin: 0;
  background: #f5f6f8;
  font-family: system-ui, sans-serif;
  color: #333;
}
header {
  background: white;
  padding: 16px;
  font-size: 20px;
  font-weight: bold;
  box-shadow: 0 1px 4px rgba(0,0,0,0.05);
}
main {
  max-width: 640px;
  margin: auto;
  padding: 16px;
}
.card {
  background: white;
  border-radius: 16px;
  padding: 16px;
  margin-bottom: 16px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.06);
}
label {
  display: block;
  margin: 12px 0 6px;
  font-weight: bold;
}
input[type=text], input[type=date], select {
  width: 100%;
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #ccc;
}
button {
  width: 100%;
  margin-top: 16px;
  padding: 12px;
  font-size: 16px;
  font-weight: bold;
  background: #2d7ff9;
  color: white;
  border: none;
  border-radius: 12px;
  cursor: pointer;
}
button.delete {
  background: #eee;
  color: #333;
  font-size: 14px;
  margin-top: 8px;
}
.log {
  background: #fafafa;
  border-radius: 12px;
  padding: 12px;
  margin-bottom: 12px;
}
.stars {
  color: #f5a623;
}
img.label {
  width: 100%;
  border-radius: 8px;
  margin-bottom: 6px;
}
.best {
  color: #d97706;
  font-weight: bold;
}
</style>
</head>

<body>
<header>ğŸ¶ ä¸€åˆä¸€ä¼š</header>

<main>

<div class="card">
  <label>ğŸ¶ æ—¥æœ¬é…’å</label>
  <input id="nameInput" type="text">

  <label>ğŸ“· ãƒ©ãƒ™ãƒ«å†™çœŸ</label>
  <input id="imageInput" type="file" accept="image/*" capture="environment">

  <label>ğŸ—“ é–‹å°æ—¥</label>
  <input id="openDateInput" type="date">

  <label>â“ ã¾ãŸé£²ã¿ãŸã„ï¼Ÿ</label>
  <select id="likeSelect">
    <option value="1">ã‚‚ã†é£²ã¾ãªã„</option>
    <option value="2">å¾®å¦™</option>
    <option value="3" selected>æ™®é€š</option>
    <option value="4">ã¾ãŸé£²ã¿ãŸã„</option>
    <option value="5">çµ¶å¯¾ã¾ãŸé£²ã‚€</option>
  </select>

  <label>ğŸŒ¡ é£²ã¿æ–¹</label>
  <select id="temperatureSelect">
    <option>å†·</option>
    <option>å¸¸æ¸©</option>
    <option>ç‡—</option>
  </select>

  <label>ğŸ½ åˆã£ãŸæ–™ç†</label>
  <select id="foodSelect">
    <option>é­š</option>
    <option>è‚‰</option>
    <option>å’Œé£Ÿ</option>
    <option>ãƒãƒ¼ã‚º</option>
    <option>å˜ä½“</option>
  </select>

  <details>
    <summary>â–¼ å‘³ã®è©³ç´°ï¼ˆä»»æ„ï¼‰</summary>

    <label>ğŸ¥› é£²ã¿ã‚„ã™ã•</label>
    <select id="waterLikeSelect">
      <option value="-2">æ°´ã¿ãŸã„</option>
      <option value="-1">è»½ã„</option>
      <option value="0" selected>æ™®é€š</option>
      <option value="1">ã—ã£ã‹ã‚Š</option>
      <option value="2">æ¿ƒåš</option>
    </select>

    <label>ğŸ”ª ã‚­ãƒ¬ãƒ»ä½™éŸ»</label>
    <select id="finishSelect">
      <option value="-1">ã‚­ãƒ¬ãŒã‚ã‚‹</option>
      <option value="0" selected>ä¸­é–“</option>
      <option value="1">ä½™éŸ»ãŒæ®‹ã‚‹</option>
    </select>

    <label>ğŸ‹ é…¸å‘³</label>
    <select id="aciditySelect">
      <option value="-1">æ§ãˆã‚</option>
      <option value="0" selected>æ™®é€š</option>
      <option value="1">å¼·ã‚</option>
    </select>

    <label>ğŸŒ¸ é¦™ã‚Š</label>
    <select id="aromaSelect">
      <option value="-1">ç©ã‚„ã‹</option>
      <option value="0" selected>ä¸­é–“</option>
      <option value="1">è¯ã‚„ã‹</option>
    </select>
  </details>

  <button id="saveButton">è¨˜éŒ²ã™ã‚‹</button>
</div>

<div class="card">
  <h3>ã“ã‚Œã¾ã§ã®è¨˜éŒ²</h3>
  <div id="logs"></div>
</div>

</main>

<script>
const STORAGE_KEY = "sake_logs_final";

const dom = {
  name: document.getElementById("nameInput"),
  image: document.getElementById("imageInput"),
  openDate: document.getElementById("openDateInput"),
  like: document.getElementById("likeSelect"),
  temperature: document.getElementById("temperatureSelect"),
  food: document.getElementById("foodSelect"),
  waterLike: document.getElementById("waterLikeSelect"),
  finish: document.getElementById("finishSelect"),
  acidity: document.getElementById("aciditySelect"),
  aroma: document.getElementById("aromaSelect"),
  save: document.getElementById("saveButton"),
  logs: document.getElementById("logs")
};

const loadLogs = () =>
  JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");

const saveLogs = logs =>
  localStorage.setItem(STORAGE_KEY, JSON.stringify(logs));

const readImage = file =>
  new Promise(r => {
    if (!file) return r(null);
    const reader = new FileReader();
    reader.onload = () => r(reader.result);
    reader.readAsDataURL(file);
  });

const daysAfter = (open, record) =>
  open ? Math.floor((new Date(record) - new Date(open)) / 86400000) : null;

function bestDayMap(logs) {
  const map = {};
  logs.forEach(l => {
    if (!l.openDate) return;
    const d = daysAfter(l.openDate, l.date);
    if (d == null) return;
    if (!map[l.name] || l.like > map[l.name].like) {
      map[l.name] = { day: d, like: l.like };
    }
  });
  return map;
}

function render() {
  const logs = loadLogs();
  const best = bestDayMap(logs);
  dom.logs.innerHTML = "";

  logs.forEach(l => {
    const d = daysAfter(l.openDate, l.date);
    const isBest = best[l.name] && best[l.name].like === l.like;

    const div = document.createElement("div");
    div.className = "log";
    div.innerHTML = `
      ${l.image ? `<img class="label" src="${l.image}">` : ""}
      <strong>${l.name}</strong><br>
      <span class="stars">${"â˜…".repeat(l.like)}${"â˜†".repeat(5-l.like)}</span><br>
      ${d !== null ? `<small>é–‹å°å¾Œ ${d}æ—¥</small><br>` : ""}
      ${isBest ? `<div class="best">ğŸŒŸ ãƒ™ã‚¹ãƒˆï¼šé–‹å°å¾Œ${best[l.name].day}æ—¥ç›®</div>` : ""}
      ğŸŒ¡ ${l.temperature}ã€€ğŸ½ ${l.food}<br>
      <small>
        é£²ã¿ã‚„ã™ã•:${l.taste.waterLike} /
        ã‚­ãƒ¬ãƒ»ä½™éŸ»:${l.taste.finish} /
        é…¸å‘³:${l.taste.acidity} /
        é¦™ã‚Š:${l.taste.aroma}
      </small><br>
      <button class="delete">å‰Šé™¤</button>
    `;
    div.querySelector("button").onclick = () => {
      saveLogs(loadLogs().filter(x => x.id !== l.id));
      render();
    };
    dom.logs.appendChild(div);
  });
}

dom.save.onclick = async () => {
  if (!dom.name.value.trim()) return alert("æ—¥æœ¬é…’åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

  const log = {
    id: Date.now(),
    name: dom.name.value.trim(),
    image: await readImage(dom.image.files[0]),
    openDate: dom.openDate.value || null,
    like: Number(dom.like.value),
    temperature: dom.temperature.value,
    food: dom.food.value,
    taste: {
      waterLike: Number(dom.waterLike.value),
      finish: Number(dom.finish.value),
      acidity: Number(dom.acidity.value),
      aroma: Number(dom.aroma.value)
    },
    date: new Date().toISOString()
  };

  const logs = loadLogs();
  logs.unshift(log);
  saveLogs(logs);
  dom.name.value = "";
  dom.image.value = "";
  render();
};

render();
</script>
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>
